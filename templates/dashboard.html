{% extends "base.html" %}
{% block styles %}
<style>
  body, .card, .list-group-item, input, button {
    background-color: #0d1117 !important;
    color: #e6edf3 !important;
  }
  .list-group-item {
    border-color: #30363d !important;
  }
  .btn {
    border-radius: 6px;
  }
  a {
    color: #58a6ff !important;
  }
  a:hover {
    color: #79c0ff !important;
  }
  .ai-summary {
    background-color: #161b22;
    border-left: 3px solid #58a6ff;
    padding: 8px 10px;
    border-radius: 6px;
    margin-top: 6px;
    color: #e6edf3;
  }
  .no-summary {
    background-color: #161b22;
    border-left: 3px solid #30363d;
    padding: 8px 10px;
    border-radius: 6px;
    margin-top: 6px;
    color: #8b949e;
    font-style: italic;
  }
  .collapse-toggle {
    font-size: 0.9rem;
    background-color: #21262d;
    border: 1px solid #30363d;
    color: #58a6ff;
  }
  .collapse-toggle:hover {
    background-color: #30363d;
    color: #79c0ff;
  }
</style>
{% endblock %}

{% block content %}
<h2 class="fw-bold mb-4">Dashboard</h2>

<div class="row">
  <!-- LEFT SIDE: Clients -->
  <div class="col-md-6">
    <div class="card mb-4 p-3 shadow-sm">
      <h5>Clients</h5>
      <ul class="list-group">
        {% if clients %}
          {% for client in clients %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <a href="{{ url_for('dash_bp.client_details', client_id=client.id) }}" class="text-decoration-none text-light">
                  {{ client.name or 'Unnamed Client' }}
                </a>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm collapse-toggle" data-bs-toggle="collapse" data-bs-target="#aiSummary{{ client.id }}">
                    View AI Summary
                  </button>
                  <form method="POST" action="{{ url_for('dash_bp.delete_client', client_id=client.id) }}">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                  </form>
                </div>
              </div>

              <!-- ðŸ§  Collapsible AI Summary Section -->
              <div id="aiSummary{{ client.id }}" class="collapse mt-2">
                {% if client.case_updates %}
                  {% for update in client.case_updates %}
                    <div class="ai-summary">
                      <small><strong>AI Summary:</strong> {{ update.summary }}</small>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="no-summary">
                    <small>No AI analysis available yet.</small>
                  </div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        {% else %}
          <li class="list-group-item">No clients yet.</li>
        {% endif %}
      </ul>

      <!-- ADD NEW CLIENT FORM -->
      <form method="POST" action="{{ url_for('dash_bp.add_client') }}" class="mt-3">
        <h6>Add New Client</h6>
        <input type="text" name="name" class="form-control mb-2" placeholder="Client name" required>
        <input type="text" name="phone" class="form-control mb-2" placeholder="Phone" required>
        <input type="email" name="email" class="form-control mb-2" placeholder="Email" required>
        <button type="submit" class="btn btn-success w-100">Add Client</button>
      </form>
    </div>
  </div>

  <!-- RIGHT SIDE: Updates & Messages -->
  <div class="col-md-6">
    <div class="card mb-4 p-3 shadow-sm">
      <h5>Recent Case Updates</h5>
      <ul class="list-group">
        {% if case_updates %}
          {% for update in case_updates %}
            <li class="list-group-item">{{ update.summary or 'No summary available' }}</li>
          {% endfor %}
        {% else %}
          <li class="list-group-item">No updates yet.</li>
        {% endif %}
      </ul>
    </div>

    <div class="card mb-4 p-3 shadow-sm">
      <h5>Recent Messages</h5>
      <ul class="list-group">
        {% if messages %}
          {% for msg in messages %}
            <li class="list-group-item">{{ msg.message or 'No message text' }}</li>
          {% endfor %}
        {% else %}
          <li class="list-group-item">No messages sent yet.</li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

<!-- RUN AI ANALYSIS BUTTON -->
<form method="POST" action="{{ url_for('dash_bp.analyze_cases') }}">
  <button type="submit" class="btn btn-primary">Run AI Analysis</button>
</form>

<!-- Bootstrap JS (for collapse toggle) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
